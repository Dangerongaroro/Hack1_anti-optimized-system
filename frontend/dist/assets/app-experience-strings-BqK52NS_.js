import{r as e,R as t,j as n}from"./vendor-react-8DDf6oIR.js";import{S as s,C as r,M as o,a as i,A as a,b as c,c as l,V as u,d as h,O as d,e as p,P as g,B as m,f,g as y,h as v,i as w,D as x,Q as D,j as S,L as M,k as b,l as P,W as C,m as T,R,n as k}from"./vendor-three-BEq7hK8x.js";import{C as E,a as L,B as z,b as F,S as I,T as j,c as A,d as O,e as _,f as Y,A as H,g as X,P as N,X as $,h as B,U as q,i as U,j as V,H as J,k as W,M as G,l as Q,m as K,n as Z,o as ee}from"./vendor-icons-CRzGubcW.js";const te={Music:ee,MapPin:Z,Coffee:K,Palette:Q,Mountain:G,Code:W,Home:J,Compass:V,BookOpen:U,User:q,ChevronRight:B,X:$,Plus:N,Calendar:X,Award:H,Sparkles:Y,TrendingUp:_,Star:O,ThumbsUp:A,ThumbsDown:j,SkipForward:I,HelpCircle:F,Book:z,Camera:L,Clock:E},ne={1:[{title:"普段聴かないジャンルの音楽を1曲聴く",icon:"Music",category:"アート",type:"music"},{title:"いつもと違う道で帰る",icon:"MapPin",category:"アウトドア",type:"place"},{title:"知らない飲み物を試してみる",icon:"Coffee",category:"食",type:"place"}],2:[{title:"隣町のカフェを開拓する",icon:"Coffee",category:"アウトドア",type:"place"},{title:"オンラインで単発の絵画教室に参加",icon:"Palette",category:"アート",type:"art"},{title:"新しいレシピで料理に挑戦",icon:"Book",category:"食",type:"skill"}],3:[{title:"日帰りで近郊の山にハイキング",icon:"Mountain",category:"アウトドア",type:"outdoor"},{title:"プログラミングの入門書を1章読む",icon:"Code",category:"学び",type:"skill"},{title:"地元の美術館で特別展を鑑賞",icon:"Palette",category:"アート",type:"art"}]},se=e=>{const t=ne[e]||ne[2];if(!t||0===t.length)return{title:"エラー: 適切なチャレンジが見つかりません",icon:"HelpCircle",category:"エラー",type:"error",level:e};return{id:`local_${Date.now()}`,title:t[Math.floor(Math.random()*t.length)].title,description:"このチャレンジはあなたのスキルを向上させるためのものです。",category:t[Math.floor(Math.random()*t.length)].category,type:"challenge",level:e}};function re(e,t){const n={"ライフスタイル":30,"アート・創作":280,"料理・グルメ":50,"ソーシャル":330,"学習・読書":210,"自然・アウトドア":120,"スポーツ・運動":170,"エンタメ":0,"その他":200},s=ie(t);let r;return r=s&&n[s]?n[s]:("number"==typeof e?47*e:e?47*e.toString().length:0)%360,`hsl(${r}, 70%, 75%)`}const oe=["ライフスタイル","アート・創作","料理・グルメ","ソーシャル","学習・読書","自然・アウトドア","スポーツ・運動","エンタメ","その他"],ie=e=>{if(!e)return"その他";if(oe.includes(e))return e;return oe.find((t=>t.includes(e)||e.includes(t)))||"その他"};const ae=new class{constructor(){this.geometryPool={sphere_small:new s(.2,16,16),sphere_medium:new s(.25,16,16),sphere_large:new s(.3,16,16),cylinder_thread:new r(.05,.05,1,8,1),particle_small:new s(.03,6,6),particle_tiny:new s(.02,8,8)},this.materialPool=new Map,this.spiralPositions=null,this.floatingPositions=null,this.connectionCurves=new Map}seededRandom(e){const t=1e4*Math.sin(e);return t-Math.floor(t)}precomputeSpiralPositions(e){if(this.spiralPositions&&this.spiralPositions.length===e)return this.spiralPositions;const t=[];for(let n=0;n<e;n++){const s=n/Math.max(e-1,1),r=6*s-3,o=2+.8*s,i=n+1e3,a=2*s*Math.PI*2+(this.seededRandom(1.234*i)-.5)*Math.PI/3,c=Math.cos(a)*o,l=Math.sin(a)*o,u=r,h=.8+.4*this.seededRandom(2.345*i),d=1.5*(this.seededRandom(3.456*i)-.5);t.push({x:c*h,y:l*h+d,z:u,scale:.8+.4*this.seededRandom(4.567*i)})}return this.spiralPositions=t,t}precomputeFloatingPositions(e,t=[]){if(this.floatingPositions&&this.floatingPositions.length===e)return this.floatingPositions;const n=[];if(0===t.length)for(let s=0;s<e;s++){const t=s/Math.max(e,1)*Math.PI*2,r=s+2e3,o=2*Math.cos(t),i=2*Math.sin(t),a=2*this.seededRandom(3.456*r)-1;n.push({x:o,y:i,z:a,seed:r})}else{const s=t[t.length-1],r=t.length;for(let t=0;t<e;t++){const e=r+t,o=e/Math.max(e,1),i=2*o*Math.PI*2,a=s.z+.8*(t+1),c=2.5+.5*o,l=t+2e3,u=i+(this.seededRandom(1.234*l)-.5)*Math.PI/4,h=Math.cos(u)*c,d=Math.sin(u)*c,p=a,g=1*(this.seededRandom(3.456*l)-.5);n.push({x:h,y:d+g,z:p,seed:l})}}return this.floatingPositions=n,n}getMaterial(e,t,n={}){const s=`${e}_${t}_${JSON.stringify(n)}`;if(!this.materialPool.has(s)){let r;switch(e){case"completed_sphere":r=new l({color:new i(t),transparent:!0,opacity:.95,metalness:.4,roughness:.05,emissive:new i(t),emissiveIntensity:.8,...n});break;case"floating_mission":r=new l({color:new i(t),transparent:!0,opacity:.95,metalness:.1,roughness:.05,emissive:new i(t).multiplyScalar(.6),emissiveIntensity:.7,...n});break;case"thread":r=new c({color:new i(t),transparent:!0,opacity:.8,emissive:new i(t),emissiveIntensity:.2,...n});break;case"particle":r=new o({color:new i(t),transparent:!0,opacity:.9,blending:a,...n});break;default:r=new o({color:new i(t),...n})}this.materialPool.set(s,r)}return this.materialPool.get(s)}getConnectionCurve(e,t,n){if(this.connectionCurves.has(n))return this.connectionCurves.get(n);const s=e.distanceTo(t),r=new u;r.addVectors(e,t),r.multiplyScalar(.5);const o=n%1e3/1e3,i=.3*s;r.add(new u((o-.5)*i,(.7*o-.35)*i,(.3*o-.15)*i));const a=new h([e.clone(),r,t.clone()]),c=a.getPoints(30),l={curve:a,points:c,segments:30,distance:s};return this.connectionCurves.set(n,l),l}dispose(){Object.values(this.geometryPool).forEach((e=>{e.dispose()})),this.materialPool.forEach((e=>{e.dispose()})),this.spiralPositions=null,this.floatingPositions=null,this.connectionCurves.clear()}};class ce{constructor(){this.animationFrameId=null,this.isRunning=!1,this.callbacks=new Set,this.lastFrameTime=0,this.targetFPS=60,this.frameInterval=1e3/this.targetFPS}addCallback(e){this.callbacks.add(e)}removeCallback(e){this.callbacks.delete(e)}start(){if(this.isRunning)return;this.isRunning=!0,this.lastFrameTime=performance.now();const e=t=>{if(!this.isRunning)return;const n=t-this.lastFrameTime;n>=this.frameInterval&&(this.callbacks.forEach((e=>{e(t,n)})),this.lastFrameTime=t),this.animationFrameId=requestAnimationFrame(e)};this.animationFrameId=requestAnimationFrame(e)}stop(){this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}dispose(){this.stop(),this.callbacks.clear()}}const le=e=>{const t=new m,n=1500,s=new Float32Array(4500),r=new Float32Array(4500),o=new Float32Array(n);console.log("⭐ 星空作成開始: 星の数 =",n);for(let a=0;a<n;a++){const e=3*a,t=ae.seededRandom(12.9898*a),n=ae.seededRandom(78.233*a),c=ae.seededRandom(39.346*a),l=40+40*c,u=t*Math.PI*2,h=n*Math.PI;s[e]=l*Math.sin(h)*Math.cos(u),s[e+1]=l*Math.sin(h)*Math.sin(u),s[e+2]=l*Math.cos(h);const d=new i;t<.5?d.setHSL(.15,.2,.7+.3*n):t<.75?d.setHSL(.6,.5,.6+.4*n):t<.9?d.setHSL(.1,.6,.5+.4*n):d.setHSL(0,.7,.4+.3*n),r[e]=d.r,r[e+1]=d.g,r[e+2]=d.b,o[a]=.3+1.2*c}t.setAttribute("position",new f(s,3)),t.setAttribute("color",new f(r,3)),t.setAttribute("size",new f(o,1));const c=new y({size:.8,vertexColors:!0,transparent:!0,opacity:.8,blending:a,sizeAttenuation:!0,map:ue()}),l=new v(t,c);return l.userData={type:"starField",isStatic:!0},e.add(l),console.log("✅ 星空作成完了: 1つのPointsオブジェクト（",n,"個の星を含む）+ 1つのテクスチャ"),l},ue=()=>{const e=document.createElement("canvas");e.width=32,e.height=32;const t=e.getContext("2d"),n=t.createRadialGradient(16,16,0,16,16,16);n.addColorStop(0,"rgba(255,255,255,1)"),n.addColorStop(.2,"rgba(255,255,255,0.8)"),n.addColorStop(.4,"rgba(255,255,255,0.4)"),n.addColorStop(1,"rgba(255,255,255,0)"),t.fillStyle=n,t.fillRect(0,0,32,32);const s=new S(e);return s.flipY=!1,s.premultiplyAlpha=!1,s},he=e=>{const t=new w(16777215,.8);t.userData={type:"ambientLight",isStatic:!0},e.add(t);const n=new x(16777215,.6);n.position.set(5,5,5),n.userData={type:"directionalLight",isStatic:!0},e.add(n);const s=new x(16777215,.3);return s.position.set(-5,3,5),s.userData={type:"directionalLight",isStatic:!0},e.add(s),{ambientLight:t,directionalLight:n,directionalLight2:s}},de=(e,t,n)=>{const s=t.filter((e=>e.completed)),r=[];console.log("🔮 完了済み球体作成開始: 球体数 =",s.length);let o=0,a=0,c=0,l=0;const u=ae.precomputeSpiralPositions(s.length);return s.forEach(((t,h)=>{const m=h/Math.max(s.length-1,1),f=new d(.2+.1*m,0);a++;const y=re(t.id,t.category),v=ae.getMaterial("completed_sphere",y);c++;const w=new p(f,v);o++;const x=u[h];w.position.set(x.x,x.y,x.z),w.scale.setScalar(x.scale),w.userData={experience:t,type:"completed",originalScale:x.scale,glowColor:new i(y),seed:t.id||h,spiralIndex:h,depth:x.z};const D=new g(new i(y),.8,3);D.position.copy(w.position),D.userData={type:"sphereLight",parentType:"completed",isStatic:!0},w.userData.light=D,e.add(D),l++,e.add(w),r.push(w),n.current.push(w)})),console.log("✅ 完了済み球体作成完了:",{"球体数":s.length,"メッシュ":o,"ジオメトリ":a,"マテリアル":c,"ライト":l,"総オブジェクト数":o+l}),r},pe=(e,t,n,s=[])=>{const r=t.filter((e=>!e.completed));console.log("🚀 浮遊ミッション作成開始: ミッション数 =",r.length);let o=0,a=0,c=0,l=0,u=0;const h=s.map((e=>e.position)),m=ae.precomputeFloatingPositions(r.length,h);r.forEach(((t,s)=>{const r=new d(.2,0);a++;const h=re(t.id,t.category),f=ae.getMaterial("floating_mission",h);c++;const y=new p(r,f);o++;const v=m[s];y.position.set(v.x,v.y,v.z),y.userData={experience:t,type:"floating",index:s,seed:v.seed,basePosition:y.position.clone(),positionFixed:!0},e.add(y),n.current.push(y);const w=new g(new i(h),.6,2.5);w.position.copy(y.position),w.userData={type:"missionLight",parentType:"floating",isStatic:!0},y.userData.light=w,e.add(w),l++;const x=ge(e,y,h,v.seed);u+=x})),console.log("✅ 浮遊ミッション作成完了:",{"ミッション数":r.length,"メッシュ":o,"ジオメトリ":a,"マテリアル":c,"ライト":l,"パーティクル":u,"総オブジェクト数":o+l+u})},ge=(e,t,n,s)=>{const r=ae.geometryPool.particle_tiny,o=ae.getMaterial("particle",n,{opacity:.4});let i=0;for(let a=0;a<5;a++){const n=new p(r,o);n.position.copy(t.position);const c=.8*ae.seededRandom(5.678*s+a)-.4,l=.8*ae.seededRandom(6.789*s+a)-.4,h=.8*ae.seededRandom(7.89*s+a)-.4;n.position.add(new u(c,l,h)),n.userData={type:"missionParticle",parentMission:t,offset:new u(c,l,h),speed:.001+.002*ae.seededRandom(8.901*s+a),isParticle:!0,isStatic:!0},e.add(n),i++}return i},me=(e,t)=>{if(t.length<2)return;console.log("🧵 接続糸作成開始: 球体数 =",t.length,"接続数 =",t.length-1);let n=0,s=0,r=0;for(let o=0;o<t.length-1;o++){const i=t[o].position,a=t[o+1].position,c=t[o].userData.experience.id+t[o+1].userData.experience.id,l=ae.getConnectionCurve(i,a,c);n+=fe(e,l,t[o],t[o+1]);const u=ye(e,l,t[o],t[o+1]);s+=u.particles,r+=u.lights}console.log("✅ 接続糸作成完了:",{"接続数":t.length-1,"セグメント":n,"糸パーティクル":s,"糸ライト":r,"総オブジェクト数":n+s+r})},fe=(e,t,n,s)=>{const{points:r}=t;let o=0;const a=ae.geometryPool.cylinder_thread;for(let l=0;l<r.length-1;l++){const t=r[l],h=r[l+1],d=(new u).subVectors(h,t),g=d.length();d.normalize();const m=l/(r.length-1),f=n.material.color,y=s.material.color,v=(new i).lerpColors(f,y,m),w=new c({color:v,transparent:!0,opacity:.95,emissive:v,emissiveIntensity:.6,shininess:150,specular:new i(16777215).multiplyScalar(.5)}),x=new p(a,w);x.scale.set(1,g,1);const S=(new u).addVectors(t,h).multiplyScalar(.5);x.position.copy(S);const M=new D;M.setFromUnitVectors(new u(0,1,0),d),x.quaternion.copy(M),x.userData={type:"connectionThread",isConnectionThread:!0,isStatic:!0},e.add(x),o++}return o},ye=(e,t,n,s)=>{const{curve:r,distance:c}=t,l=Math.max(5,Math.floor(3*c));let u=0,h=0;const d=ae.geometryPool.particle_small;for(let m=0;m<l;m++){const t=m/l,c=r.getPoint(t),f=(new i).lerpColors(new i(re(n.userData.experience.id)),new i(re(s.userData.experience.id)),t),y=new o({color:f,transparent:!0,opacity:.9,blending:a}),v=new p(d,y);v.position.copy(c);const w=new g(f,.3,1.5);w.position.copy(c),w.userData={type:"threadParticleLight",parentType:"threadParticle",isStatic:!0},e.add(w),h++,v.userData={type:"threadParticle",isThreadParticle:!0,baseOpacity:.9,phase:m/l*Math.PI*2,isStatic:!0,light:w},e.add(v),u++}return{particles:u,lights:h}},ve=e=>{const t=performance.now(),n=e.filter((e=>e.completed)).length,s=e.filter((e=>!e.completed)).length,r=Math.max(0,n-1),o=2*n,i=7*s,a=Math.max(5,Math.floor(6)),c=r*(30+2*a),l=1+o+i+c;console.log("🔍 パフォーマンス分析レポート"),console.log("=========================================="),console.log("📊 Experience データ:"),console.log("  - 総Experience数:",e.length),console.log("  - 完了済み:",n),console.log("  - 未完了:",s),console.log("  - 接続数:",r),console.log(""),console.log("🎯 オブジェクト内訳:"),console.log("  ⭐ 星空:",1,"オブジェクト (",1500,"個の星点を含む)"),console.log("  🔮 完了済み球体:",n,"個 ×2 =",o,"オブジェクト"),console.log("  🚀 浮遊ミッション:",s,"個 ×7 =",i,"オブジェクト"),console.log("  🧵 接続糸:",r,"本 × ~",30+2*a,"=",c,"オブジェクト"),console.log(""),console.log("📈 総推定オブジェクト数:",l),console.log("✅ 差分更新システムによりパフォーマンス最適化済み");const u=performance.now();return console.log("⏱️ 分析時間:",(u-t).toFixed(2),"ms"),console.log("=========================================="),l},we=t=>{const n=e.useRef(null),s=e.useRef(null),r=e.useRef(null),o=e.useRef(null),i=e.useRef([]),a=e.useRef(null),c=e.useRef(null),l=e.useRef([]),{startOptimizedAnimation:u,disposeOptimizedAnimation:h}=(()=>{const e=new ce,t=e=>{e&&(e.rotation.y+=1e-4,e.rotation.x+=5e-5)},n=(e,t,n)=>{const r=.001*n;t.current||e.current.forEach((e=>{if("completed"===e.userData.type||"floating"===e.userData.type){const t=e.userData.originalScale||1;e.scale.setScalar(t),e.material&&void 0!==e.material.emissiveIntensity&&(e.material.emissiveIntensity=.3)}})),e.current.forEach((e=>{if("completed"===e.userData.type){const s=e.userData.originalScale||1;if(e===t.current&&e.userData.hoverStartTime){const t=.005*(n-e.userData.hoverStartTime),r=s*(1.3+.2*Math.sin(3*t));e.scale.setScalar(r),e.rotation.y+=.02,e.rotation.x+=.01;const o=.6+.2*Math.sin(4*t);e.material.emissiveIntensity=o,e.userData.light&&(e.userData.light.intensity=.8+.2*Math.sin(4*t))}else{const t=s*(1+.05*Math.sin(2*r));e.scale.setScalar(t);const n=.3+.1*Math.sin(3*r);e.material.emissiveIntensity=n,e.userData.light&&(e.userData.light.intensity=.5+.1*Math.sin(3*r))}}else"floating"===e.userData.type&&s(e,t,n)}))},s=(e,t,n)=>{const s=8e-4*n,r=e===t.current,o=.008+e.userData.index%4*.003;if(e.rotation.x+=o,e.rotation.y+=.7*o,e.rotation.z+=.4*o,r?(e.userData.hoverStartTime||(e.userData.hoverStartTime=n,e.userData.isHovering=!0),e.userData.hoverEndTime=null):e.userData.isHovering&&(e.userData.hoverEndTime?n-e.userData.hoverEndTime>150&&(e.userData.hoverStartTime=null,e.userData.hoverEndTime=null,e.userData.isHovering=!1):e.userData.hoverEndTime=n),e.userData.isHovering&&e.userData.hoverStartTime){const t=.008*(n-e.userData.hoverStartTime),s=1.5+.3*Math.sin(4*t);e.scale.setScalar(s),e.rotation.x+=.05,e.rotation.y+=.04,e.rotation.z+=.06,void 0!==e.material.emissiveIntensity&&(e.material.emissiveIntensity=.8+.2*Math.sin(4*t))}else{const t=1+.2*Math.sin(2*s+2*e.userData.index);e.scale.setScalar(t),void 0!==e.material.emissiveIntensity&&(e.material.emissiveIntensity=.3+.2*Math.sin(4*s+e.userData.index))}},r=(e,t)=>{const n=.001*t;e.traverse((e=>{if(e.userData.parentMission&&e.userData.isParticle){const t=n*e.userData.speed*.8;e.material&&(e.material.opacity=.2+.2*Math.sin(3*t));const s=1+.1*Math.sin(2*t);e.scale.setScalar(s)}if(e.userData.isThreadParticle&&void 0!==e.userData.baseOpacity&&e.material){const t=e.userData.phase||0;e.material.opacity=Math.max(.1,e.userData.baseOpacity+.2*Math.sin(2*n+t))}if(e.userData.isSparkle){e.rotation.x+=.02,e.rotation.y+=.01,e.rotation.z+=.015,e.material&&(e.material.opacity=.3+.3*Math.sin(5*n+e.userData.phase));const t=1+.2*Math.sin(3*n+e.userData.phase);e.scale.setScalar(t)}}))};return{animateStars:t,animateSpheres:n,animateSceneParticles:r,startOptimizedAnimation:(s,o,i,a,c,l)=>{const u=e=>{t(o),n(i,a,e),r(s,e),c&&l&&s&&c.render(s,l)};return e.addCallback(u),e.start(),()=>{e.removeCallback(u),e.stop()}},disposeOptimizedAnimation:()=>{e.dispose()},animationManager:e}})(),d=(e=n.current)=>{if(!e)return;const t=[],s={};e.traverse((n=>{var r;const o=(null==(r=n.userData)?void 0:r.type)||n.type||"unknown",i=n.constructor.name;if(!(n instanceof M||n.isBackground||n.userData&&"completed"===n.userData.type||n.userData&&"starField"===n.userData.type||n.userData&&"ambientLight"===n.userData.type||n.userData&&"directionalLight"===n.userData.type)&&n!==e){const e=`${i}(${o})`;s[e]=(s[e]||0)+1,t.push(n)}})),console.log("🗑️ 削除対象オブジェクト詳細:"),Object.entries(s).forEach((([e,t])=>{console.log(`  - ${e}: ${t}個`)})),console.log(`🧹 クリーンアップ: ${t.length}個のオブジェクトを削除`),t.forEach((t=>{var n,s;e.remove(t),t.geometry&&!(null==(n=t.userData)?void 0:n.isPooled)&&t.geometry.dispose(),t.material&&!(null==(s=t.userData)?void 0:s.isPooled)&&(Array.isArray(t.material)?t.material.forEach((e=>e.dispose())):t.material.dispose())}))};return{sceneRef:n,cameraRef:s,rendererRef:r,raycasterRef:o,meshesRef:i,hoveredMeshRef:a,initializeScene:(e,a=null,c=!1)=>{const u=e.getBoundingClientRect(),h=new b,p=new P(75,u.width/u.height,.1,1e3),g=new C({canvas:e,alpha:!0,antialias:window.devicePixelRatio<=1,powerPreference:"high-performance"});if(g.outputColorSpace="srgb",T.enabled=!0,n.current=h,s.current=p,r.current=g,o.current=new R,o.current.params.Points.threshold=.5,g.setSize(u.width,u.height),g.setClearColor(0,0),g.setPixelRatio(Math.min(window.devicePixelRatio,2)),g.shadowMap.enabled=!1,p.position.set(0,0,5),p.lookAt(0,0,0),console.log("🔍 クリーンアップ判定:",{forceCleanup:c,"シーン存在":!!h,"シーン子要素数":h.children.length}),c?(i.current=[],d(h),console.log("🧹 強制クリーンアップ実行 - 全オブジェクト削除")):console.log("🔄 差分更新モード - 既存オブジェクト保持"),a&&!0===a.isServerData){console.log("🔧 サーバーサイド計算結果を使用します",a);const e=le(h);he(h);const n=de(h,t,i);return me(h,n),pe(h,t,i,n),ve(t),l.current=[...t],{scene:h,renderer:g,camera:p,stars:e,meshesRef:i,hoveredMeshRef:{current:null},initComplete:!0}}{console.log("💻 フロントエンドビジュアライゼーションを使用します");const e=le(h);he(h);const n=de(h,t,i);return me(h,n),pe(h,t,i,n),ve(t),l.current=[...t],{scene:h,camera:p,renderer:g,stars:e}}},startAnimation:e=>{c.current&&c.current();const t=u(n.current,e,i,a,r.current,s.current);return c.current=t,t},handleResize:e=>{const t=e.getBoundingClientRect();s.current&&r.current&&(s.current.aspect=t.width/t.height,s.current.updateProjectionMatrix(),r.current.setSize(t.width,t.height))},cleanup:()=>{c.current&&(c.current(),c.current=null),d(),r.current&&(r.current.dispose(),r.current=null),h(),ae.dispose(),n.current=null,s.current=null,o.current=null,i.current=[],a.current=null},getInteractableMeshes:()=>i.current.filter((e=>"completed"===e.userData.type||"floating"===e.userData.type)),setOptimizedHoveredMesh:e=>{a.current&&a.current!==e&&(a.current.userData.hoverStartTime=null,a.current.userData.isHovering=!1),a.current=e,e&&(e.userData.hoverStartTime=Date.now(),e.userData.isHovering=!0)},cleanupOptimizedScene:d,updateSceneDifferentially:e=>{console.log("🔄 差分更新システム開始");const t=l.current,s=e.filter((e=>!t.find((t=>t.id===e.id)))),r=e.filter((e=>e.completed&&!t.find((t=>t.id===e.id&&t.completed))));if(console.log("📊 差分分析:",{"新規体験":s.length,"新規完了":r.length,"既存保持":t.length}),0===s.length&&0===r.length)return console.log("🎯 変更なし - スキップ"),!1;const o=n.current;if(!o)return!1;if(r.length>0){const e=de(o,r,i);console.log("✅ 新しい完了済み球体を追加:",e.length)}const a=s.filter((e=>!e.completed));if(a.length>0){const e=i.current.filter((e=>"completed"===e.userData.type));pe(o,a,i,e),console.log("🚀 新しい浮遊ミッションを追加:",a.length)}if(r.length>0){((e,t,n)=>{console.log("🧵 接続糸の部分更新開始");let s=0,r=0;t.forEach((t=>{if(n.length>0){const o=n.reduce(((e,n)=>t.position.distanceTo(n.position)<t.position.distanceTo(e.position)?n:e)),i=t.userData.experience.id+o.userData.experience.id,a=ae.getConnectionCurve(t.position,o.position,i),c=fe(e,a,t,o),l=ye(e,a,t,o);s++,r+=c+l.particles+l.lights}})),console.log("✅ 接続糸部分更新完了:",{"新規接続数":s,"追加オブジェクト":r})})(o,i.current.filter((e=>"completed"===e.userData.type&&r.find((t=>t.id===e.userData.experience.id)))),i.current.filter((e=>"completed"===e.userData.type&&!r.find((t=>t.id===e.userData.experience.id))))),console.log("🧵 接続糸の部分更新完了 - 新規接続のみ追加")}return l.current=[...e],!0}}},xe=({experiences:s=[],onExperienceClick:r})=>{const o=e.useRef(null),i=e.useRef(null),a=e.useRef(new k),[c,l]=e.useState(!1),h=e.useRef(!1),d=e.useRef({x:0,y:0}),{visualizationData:p,isLoading:g,useServerData:m}=(t=>{const[n,s]=e.useState(null),[r,o]=e.useState(!1),[i,a]=e.useState(!1),[c,l]=e.useState(null),u=e.useCallback((e=>{if(!e||0===e.length)return console.log("⚠️ 体験データがありません"),null;console.log("🔍 受信した体験データ:",e);const t=e.filter((e=>e.isCompleted||e.completed)),n=e.filter((e=>!e.isCompleted&&!e.completed));return console.log("📊 体験データ分析:",{totalExperiences:e.length,completedExperiences:t.length,incompleteExperiences:n.length,sampleExperience:e[0]?{id:e[0].id,isCompleted:e[0].isCompleted,completed:e[0].completed,title:e[0].title}:null}),{spheres:t.map(((e,t)=>({id:e.id||t,position:{x:0,y:0,z:0},color:e.color||"#4FC3F7",scale:1,experience:e,type:"completed"}))),floatingMissions:n.slice(0,5).map(((e,t)=>({id:e.id||`floating_${t}`,position:{x:0,y:0,z:0},color:e.color||"#81C784",scale:.8,experience:e,type:"floating"}))),connections:t.length>1?t.slice(0,-1).map(((e,t)=>({from:t,to:t+1,strength:.8,color:"#FFFFFF"}))):[],stars:{count:200,distribution:"optimized"},lighting:{ambient:.4,directional:.6},isServerData:!1,generatedAt:(new Date).toISOString()}}),[]),h=e.useCallback((async e=>{try{o(!0),l(null);const t=await fetch("/api/visualization/experience-strings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Server responded with ${t.status}: ${t.statusText}`);const n=await t.json();if(n&&"success"===n.status){const e={...n.data,isServerData:!0};return s(e),a(!0),console.log("✅ サーバーサイドビジュアライゼーションデータを取得しました"),e}throw new Error("Server returned invalid data structure")}catch(t){console.warn("⚠️ サーバーサイドビジュアライゼーション取得に失敗:",t.message),l(t.message);const n=u(e);return s(n),a(!1),console.log("🔄 フロントエンドフォールバックデータを使用します"),n}finally{o(!1)}}),[u]);return e.useEffect((()=>{if(!t||0===t.length)return void s(null);let e=!0;return(async()=>{try{const n=await h(t);e&&s(n)}catch(n){if(console.error("ビジュアライゼーションデータの読み込みに失敗:",n),e){const e=u(t);s(e),a(!1)}}})(),()=>{e=!1}}),[t,h,u]),{visualizationData:n,isLoading:r,useServerData:i,serverError:c,retryServerData:e.useCallback((async()=>{t&&t.length>0&&await h(t)}),[t,h]),forceUseFrontendData:e.useCallback((()=>{const e=u(t);s(e),a(!1),l(null),console.log("🔄 フロントエンドデータに強制切り替えしました")}),[t,u])}})(s),f=e.useRef({isTouch:!1,isDragging:!1,isPinching:!1,lastTouch:{x:0,y:0},lastDistance:0,touches:[],tapStartTime:0,tapStartPos:{x:0,y:0},isTap:!1}),{cameraRef:y,raycasterRef:v,initializeScene:w,startAnimation:x,handleResize:D,cleanup:S,getInteractableMeshes:M,sceneRef:b,updateSceneDifferentially:P}=we(s),C=e.useCallback((e=>{c&&o.current&&(console.log("🖱️ クリック処理開始"),requestIdleCallback((()=>{var t,n,s;const i=o.current.getBoundingClientRect(),c=e.clientX-i.left,l=e.clientY-i.top;a.current.x=c/i.width*2-1,a.current.y=-l/i.height*2+1;const u=M();if(console.log("📋 クリック可能なメッシュ数:",u.length),v.current&&y.current&&u.length>0){v.current.setFromCamera(a.current,y.current);const e=v.current.intersectObjects(u);if(console.log("🎯 レイキャスト結果:",e.length,"つのオブジェクトがヒット"),e.length>0){const o=e[0].object.userData;console.log("📦 クリックされたオブジェクト:",{type:o.type,experienceId:null==(t=o.experience)?void 0:t.id,experienceTitle:null==(n=o.experience)?void 0:n.title,isCompleted:null==(s=o.experience)?void 0:s.completed}),"floating"===o.type?(console.log("🎈 浮遊ミッションクリック - 詳細表示のみ実行"),o.experience&&r&&r(o.experience)):o.experience&&r&&(console.log("⚪ 完了済み球体クリック - 詳細表示実行"),r(o.experience))}else console.log("❌ クリック対象が見つかりませんでした")}})))}),[c,M,r,y,v]),T=e.useCallback((e=>{if(!c||!y.current)return;e.preventDefault();const t=new u;y.current.getWorldDirection(t);const n=new u(0,0,0),s=.05*e.deltaY;let r=y.current.position.distanceTo(n)+s;r=Math.max(2,Math.min(30,r)),y.current.position.copy(n.clone().add(t.multiplyScalar(-r))),y.current.lookAt(n)}),[c,y]),R=e.useCallback((e=>{f.current.isTouch||(h.current=!0,d.current={x:e.clientX,y:e.clientY})}),[]),E=e.useCallback((()=>{f.current.isTouch||(h.current=!1)}),[]),L=e.useCallback((e=>{if(!h.current||!y.current||f.current.isTouch)return;const t=e.clientX-d.current.x,n=e.clientY-d.current.y;y.current.position.x-=.01*t,y.current.position.y+=.01*n,y.current.lookAt(0,0,0),d.current={x:e.clientX,y:e.clientY}}),[y]),z=e.useCallback((e=>{if(e.preventDefault(),f.current.isTouch=!0,1===e.touches.length){const t=e.touches[0];f.current.tapStartTime=Date.now(),f.current.tapStartPos={x:t.clientX,y:t.clientY},f.current.lastTouch={x:t.clientX,y:t.clientY},f.current.isTap=!0,f.current.isDragging=!1}else if(2===e.touches.length){f.current.isPinching=!0,f.current.isDragging=!1,f.current.isTap=!1;const t=e.touches[0].clientX-e.touches[1].clientX,n=e.touches[0].clientY-e.touches[1].clientY;f.current.lastDistance=Math.sqrt(t*t+n*n)}f.current.touches=Array.from(e.touches)}),[]),F=e.useCallback((e=>{if(e.preventDefault(),y.current){if(1===e.touches.length&&f.current.isTap){const t=e.touches[0],n=Math.abs(t.clientX-f.current.tapStartPos.x),s=Math.abs(t.clientY-f.current.tapStartPos.y);Math.sqrt(n*n+s*s)>10&&(f.current.isTap=!1,f.current.isDragging=!0)}if(1===e.touches.length&&f.current.isDragging&&!f.current.isTap){const t=e.touches[0],n=t.clientX-f.current.lastTouch.x,s=t.clientY-f.current.lastTouch.y,r=.015;y.current.position.x-=n*r,y.current.position.y+=s*r,y.current.lookAt(0,0,0),f.current.lastTouch={x:t.clientX,y:t.clientY}}else if(2===e.touches.length&&f.current.isPinching){const t=e.touches[0].clientX-e.touches[1].clientX,n=e.touches[0].clientY-e.touches[1].clientY,s=Math.sqrt(t*t+n*n);if(f.current.lastDistance>0){const e=s-f.current.lastDistance,t=.01,n=y.current,r=n.position.length(),o=Math.max(5,Math.min(50,r-e*t)),i=n.position.clone().normalize();n.position.copy(i.multiplyScalar(o)),n.lookAt(0,0,0)}f.current.lastDistance=s}}}),[y]),I=e.useCallback((e=>{var t,n,s;if(e.preventDefault(),f.current.isTap&&c&&o.current){if(Date.now()-f.current.tapStartTime<300){console.log("📱 タッチタップ処理開始");const e=o.current.getBoundingClientRect(),i=f.current.tapStartPos.x-e.left,c=f.current.tapStartPos.y-e.top;a.current.x=i/e.width*2-1,a.current.y=-c/e.height*2+1;const l=M();if(console.log("📋 タップ可能なメッシュ数:",l.length),v.current&&y.current&&l.length>0){v.current.setFromCamera(a.current,y.current);const e=v.current.intersectObjects(l);if(console.log("🎯 タップレイキャスト結果:",e.length,"つのオブジェクトがヒット"),e.length>0){const o=e[0].object.userData;console.log("📦 タップされたオブジェクト:",{type:o.type,experienceId:null==(t=o.experience)?void 0:t.id,experienceTitle:null==(n=o.experience)?void 0:n.title,isCompleted:null==(s=o.experience)?void 0:s.completed}),o.experience&&r&&("floating"===o.type?console.log("🎈 浮遊ミッションタップ - 詳細表示のみ実行"):console.log("⚪ 完了済み球体タップ - 詳細表示実行"),r(o.experience))}else console.log("❌ タップ対象が見つかりませんでした")}}}0===e.touches.length?(f.current.isTouch=!1,f.current.isDragging=!1,f.current.isPinching=!1,f.current.isTap=!1,f.current.lastDistance=0,f.current.tapStartTime=0):1===e.touches.length&&f.current.isPinching&&(f.current.isPinching=!1,f.current.isDragging=!0,f.current.isTap=!1,f.current.lastTouch={x:e.touches[0].clientX,y:e.touches[0].clientY}),f.current.touches=Array.from(e.touches)}),[c,M,r,y,v]);e.useEffect((()=>{if(!o.current||0===s.length)return;if(c&&b.current)return void console.log("🚀 シーンは既に初期化済み - 初期化スキップ（差分更新は別のuseEffectで処理）");if(g)return void console.log("🔄 サーバーサイドビジュアライゼーションデータ読み込み中...");const e=o.current;let t=null;try{m&&p?console.log("🖥️ サーバーサイドビジュアライゼーションデータを使用:",p):console.log("💻 フロントエンド計算でビジュアライゼーションを実行");const n=!c;console.log("🎯 初期化モード分析:",{isInitialized:c,forceCleanup:n,experiencesLength:s.length,"シーン参照存在":!!b.current});const{stars:r}=w(e,p,n);t=x(r),l(!0),console.log("✅ 3Dビジュアライゼーションが正常に初期化されました");const o=()=>D(e);return window.addEventListener("resize",o),e.addEventListener("wheel",T,{passive:!1}),e.addEventListener("click",C),e.addEventListener("mousedown",R),e.addEventListener("mouseup",E),e.addEventListener("mouseleave",E),e.addEventListener("mousemove",L),e.addEventListener("touchstart",z,{passive:!1}),e.addEventListener("touchmove",F,{passive:!1}),e.addEventListener("touchend",I,{passive:!1}),e.addEventListener("touchcancel",I,{passive:!1}),()=>{l(!1),t&&t(),window.removeEventListener("resize",o),e.removeEventListener("wheel",T),e.removeEventListener("click",C),e.removeEventListener("mousedown",R),e.removeEventListener("mouseup",E),e.removeEventListener("mouseleave",E),e.removeEventListener("mousemove",L),e.removeEventListener("touchstart",z),e.removeEventListener("touchmove",F),e.removeEventListener("touchend",I),e.removeEventListener("touchcancel",I),S()}}catch(n){console.error("最適化されたシーンの初期化に失敗しました:",n),l(!1)}}),[p,g,m,s.length]),e.useEffect((()=>{if(!c||!o.current||0===s.length)return;console.log("🔄 差分更新チェック - experiencesの内容変更を検出");P(s)&&console.log("✅ 差分更新完了 - 新しいオブジェクトのみ追加")}),[s,c,P]);const j=t.useMemo((()=>({completed:s.filter((e=>e.completed)).length,floating:s.filter((e=>!e.completed)).length})),[s]);return n.jsx("div",{className:"px-4 bg-black",ref:i,children:n.jsxs("div",{className:"relative mb-8 bg-black rounded-3xl shadow-2xl overflow-hidden",children:[n.jsx("div",{className:"absolute inset-0 bg-black"}),n.jsx("canvas",{ref:o,className:"w-full h-96 cursor-crosshair relative z-10 bg-black",style:{background:"#000"}}),"        ",n.jsxs("div",{className:"absolute bottom-4 left-4 text-white/80 text-sm z-10",children:[n.jsxs("p",{className:"mb-1",children:["🎯 体験の糸: ",j.completed,"本"]}),n.jsxs("p",{children:["💫 浮遊ミッション: ",j.floating,"個"]}),!c&&n.jsx("p",{className:"text-yellow-300",children:"🔄 最適化中..."}),p&&n.jsx("p",{className:"mt-1 "+(p.isServerData?"text-green-300":"text-orange-300"),children:p.isServerData?"🔧 サーバー計算使用中":"💻 フロントエンド計算使用中"})]}),n.jsxs("div",{className:"absolute bottom-4 right-4 text-white/60 text-xs z-10",children:[n.jsxs("div",{className:"hidden md:block",children:[n.jsx("p",{children:"マウスホイール: ズーム"}),n.jsx("p",{children:"ドラッグ: 視点移動"}),n.jsx("p",{children:"クリック: 体験を選択"})]}),n.jsxs("div",{className:"md:hidden",children:[n.jsx("p",{children:"ピンチ: ズーム"}),n.jsx("p",{children:"ドラッグ: 視点移動"}),n.jsx("p",{children:"タップ: 体験を選択"})]}),"        "]})]})})};export{xe as O,se as g,te as i};
